@startuml
!define C4P https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master
!includeurl C4P/C4_Container.puml

title Gestión CSC - C2 Diagrama de Contenedores (v1.1.0)

Person(cliente, "Cliente", "Dueño del proyecto de construcción")
Person(usuario, "Usuario", "Proveedor/Contratista")
Person(admin, "Administrador", "Gestiona usuarios, accesos y configuración del sistema")

System_Boundary(gestionCSC, "Gestión CSC") {

    Container(webAppOwner, "App Web Cliente", "Angular", "Interfaz web para los dueños del proyecto")

    Container(webAppBusiness, "App Web Empresa", "Angular", "Interfaz web para los contratistas y proveedores")

    Container(webAppAdmin, "App Web Administrador", "Angular", "Interfaz web para los administradores del sistema")

    Container(apiGateway, "API Gateway", "Spring Cloud Gateway", "Punto de entrada único, validación de seguridad y ruteo")

    Container(msIdentidad, "ms-identidad", "Spring Boot", "Autenticación, autorización y gestión de usuarios")

    Container(msEmpresa, "ms-empresa", "Spring Boot", "Gestión del ciclo de vida del proyecto y empresas")

    Container(msMaterial, "ms-material", "Spring Boot", "Gestión de inventario, logística y materiales")

    Container(msFinanza, "ms-finanzas", "Spring Boot", "Gestión de pagos, facturación y transacciones")

    Container(eventBus, "Event Bus", "Apache Kafka", "Mensajería asíncrona para eventos de dominio")

    ContainerDb(dbIdentidad, "DB Identidad", "PostgreSQL", "Usuarios, roles y credenciales")

    ContainerDb(dbEmpresa, "DB Empresa", "PostgreSQL", "Empresas, proyectos y estados")

    ContainerDb(dbMaterial, "DB Material", "PostgreSQL", "Inventario, órdenes y logística")

    ContainerDb(dbFinanzas, "DB Finanzas", "PostgreSQL", "Pagos, facturación y transacciones")
}

System_Ext(notifProvider, "Servicio de Notificaciones", "SMS, Push, Email, WhatsApp")

System_Ext(paymentGateway, "Pasarela de Pagos", "Procesamiento de pagos")

System_Ext(transportProvider, "Proveedor de Transporte", "Transporte de materiales y equipos de construcción")

' Usuarios → Frontend
Rel(cliente, webAppOwner, "Usa")
Rel(usuario, webAppBusiness, "Usa")
Rel(admin, webAppAdmin, "Administra")

' Frontend → Gateway (Sync)
Rel(webAppOwner, apiGateway, "Consume API REST", "HTTPS/JSON")
Rel(webAppBusiness, apiGateway, "Consume API REST", "HTTPS/JSON")
Rel(webAppAdmin, apiGateway, "Consume API REST", "HTTPS/JSON")

' Gateway → Microservicios (Sync)
Rel(apiGateway, msIdentidad, "Autentica y autoriza solicitudes")
Rel(apiGateway, msEmpresa, "Rutea comandos")
Rel(apiGateway, msMaterial, "Rutea comandos")
Rel(apiGateway, msFinanza, "Rutea comandos")

' Microservicios → Event Bus (Async)
Rel(msEmpresa, eventBus, "Publica eventos de dominio (cambios relevantes en el ciclo de vida del proyecto)")
Rel(msMaterial, eventBus, "Publica eventos de dominio (inventario, logística y órdenes de material)")

' Event Bus → Microservicios (Async)
Rel(eventBus, msMaterial, "Consume eventos de dominio del proyecto")
Rel(eventBus, msFinanza, "Consume eventos de dominio del proyecto y de materiales")

' Microservicios → DB
Rel(msIdentidad, dbIdentidad, "Lee/Escribe")
Rel(msEmpresa, dbEmpresa, "Lee/Escribe")
Rel(msMaterial, dbMaterial, "Lee/Escribe")
Rel(msFinanza, dbFinanzas, "Lee/Escribe")

' Integraciones externas
Rel(msIdentidad, notifProvider, "Notifica autenticación y seguridad")
Rel(msMaterial, notifProvider, "Notifica estados de envíos e inventario")
Rel(msFinanza, notifProvider, "Notifica pagos y facturación")
Rel(msFinanza, paymentGateway, "Procesa pagos")
Rel(msMaterial, transportProvider, "Solicita transporte")

SHOW_LEGEND()
@enduml
